{% extends "base.html" %}
{% block title %}Dashboard - WiFi Billing{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- System Health Banner -->
<div class="alert alert-{{ 'success' if system_status.radius.running and system_status.database.connected else 'danger' }} d-flex justify-content-between align-items-center mb-4">
    <div>
        <i class="bi bi-{{ 'check-circle' if system_status.radius.running and system_status.database.connected else 'exclamation-triangle' }}"></i>
        <strong>System Status:</strong>
        <span class="mx-2">RADIUS: {{ 'Online' if system_status.radius.running else 'Offline' }}</span>
        <span class="mx-2">|</span>
        <span class="mx-2">Database: {{ 'Connected' if system_status.database.connected else 'Disconnected' }}</span>
        <span class="mx-2">|</span>
        <span class="mx-2">WireGuard: {{ 'Active' if system_status.wireguard.running else 'Inactive' }} ({{ system_status.wireguard.connected_peers }}/{{ system_status.wireguard.peers }} peers)</span>
    </div>
    <a href="{{ url_for('system_status') }}" class="btn btn-sm btn-outline-{{ 'success' if system_status.radius.running and system_status.database.connected else 'danger' }}">
        <i class="bi bi-gear"></i> Details
    </a>
</div>

{% if not stats.db_connected %}
<div class="alert alert-danger">
    <i class="bi bi-database-x"></i> <strong>Database Connection Error!</strong> Cannot connect to the database. Check MariaDB service.
</div>
{% endif %}

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="value">{{ stats.active_sessions }}</div>
                    <div class="label">Active Sessions</div>
                </div>
                <div class="icon bg-primary bg-opacity-10 text-primary">
                    <i class="bi bi-people-fill"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="value">{{ stats.active_vouchers }}</div>
                    <div class="label">Active Vouchers</div>
                </div>
                <div class="icon bg-success bg-opacity-10 text-success">
                    <i class="bi bi-ticket-perforated-fill"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="value">{{ stats.unused_vouchers }}</div>
                    <div class="label">Unused Vouchers</div>
                </div>
                <div class="icon bg-info bg-opacity-10 text-info">
                    <i class="bi bi-ticket"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="value">{{ stats.total_routers }}</div>
                    <div class="label">Active Routers</div>
                </div>
                <div class="icon bg-warning bg-opacity-10 text-warning">
                    <i class="bi bi-router-fill"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="value">{{ stats.total_vouchers }}</div>
                    <div class="label">Total Vouchers</div>
                </div>
                <div class="icon bg-secondary bg-opacity-10 text-secondary">
                    <i class="bi bi-collection"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="value">{{ stats.expired_vouchers }}</div>
                    <div class="label">Expired Vouchers</div>
                </div>
                <div class="icon bg-danger bg-opacity-10 text-danger">
                    <i class="bi bi-x-circle"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="value">{{ format_bytes(stats.total_data_today) }}</div>
                    <div class="label">Data Used Today</div>
                </div>
                <div class="icon bg-purple bg-opacity-10 text-purple" style="background: rgba(136,71,255,0.1); color: #8847ff;">
                    <i class="bi bi-arrow-down-up"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Recent Sessions -->
<div class="row g-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-lightning-charge"></i> Quick Actions
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('vouchers') }}?action=generate" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Generate Vouchers
                    </a>
                    <a href="{{ url_for('routers') }}" class="btn btn-outline-primary">
                        <i class="bi bi-router"></i> Manage Routers
                    </a>
                    <a href="{{ url_for('sessions') }}" class="btn btn-outline-primary">
                        <i class="bi bi-people"></i> View Sessions
                    </a>
                    <a href="{{ url_for('reports') }}" class="btn btn-outline-primary">
                        <i class="bi bi-graph-up"></i> View Reports
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity"></i> Recent Active Sessions</span>
                <a href="{{ url_for('sessions') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>IP Address</th>
                                <th>NAS IP</th>
                                <th>Started</th>
                                <th>Data Used</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td><code>{{ session.username }}</code></td>
                                <td>{{ session.framedipaddress or '-' }}</td>
                                <td>{{ session.nasipaddress }}</td>
                                <td>{{ session.acctstarttime.strftime('%H:%M:%S') if session.acctstarttime else '-' }}</td>
                                <td>{{ format_bytes((session.acctinputoctets or 0) + (session.acctoutputoctets or 0)) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">No active sessions</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh stats every 30 seconds
setInterval(function() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            // Update stats if needed
        });
}, 30000);
</script>
{% endblock %}
