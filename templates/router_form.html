{% extends "base.html" %}
{% block title %}{{ 'Edit' if router else 'Add' }} Router - WiFi Billing{% endblock %}
{% block page_title %}{{ 'Edit' if router else 'Add New' }} Router{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-router"></i> RADIUS Settings
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Router IP Address <span class="text-danger">*</span></label>
                            <input type="text" name="nasname" class="form-control" 
                                   value="{{ router.nasname if router else '' }}" 
                                   placeholder="192.168.88.1" required>
                            <small class="text-muted">Internal IP that sends RADIUS requests</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Short Name <span class="text-danger">*</span></label>
                            <input type="text" name="shortname" class="form-control" 
                                   value="{{ router.shortname if router else '' }}" 
                                   placeholder="Main Router" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">RADIUS Secret <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" name="secret" class="form-control" id="secretInput"
                                       value="{{ router.secret if router else '' }}" 
                                       placeholder="your_secret_key" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="generateSecret()">
                                    <i class="bi bi-shuffle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Router Type</label>
                            <select name="type" class="form-select">
                                <option value="other" {{ 'selected' if not router or router.type == 'other' else '' }}>MikroTik</option>
                                <option value="cisco" {{ 'selected' if router and router.type == 'cisco' else '' }}>Cisco</option>
                                <option value="ubiquiti" {{ 'selected' if router and router.type == 'ubiquiti' else '' }}>Ubiquiti</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">CoA Port</label>
                            <input type="number" name="coa_port" class="form-control" 
                                   value="{{ router.coa_port if router else 3799 }}">
                        </div>
                        {% if router %}
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="active" {{ 'selected' if router.status == 'active' else '' }}>Active</option>
                                <option value="inactive" {{ 'selected' if router.status == 'inactive' else '' }}>Inactive</option>
                            </select>
                        </div>
                        {% endif %}
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="2" 
                                      placeholder="Optional description...">{{ router.description if router else '' }}</textarea>
                        </div>
                    </div>
                    
                    <!-- WireGuard VPN Section -->
                    <hr class="my-4">
                    <div class="d-flex align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-shield-lock"></i> WireGuard VPN Tunnel (Recommended for NAT)</h6>
                        <div class="form-check form-switch ms-3">
                            <input class="form-check-input" type="checkbox" name="wg_enabled" id="wgEnabled"
                                   {{ 'checked' if router and router.wg_enabled else '' }} onchange="toggleWgFields()">
                            <label class="form-check-label" for="wgEnabled">Enable WireGuard</label>
                        </div>
                    </div>
                    
                    <div class="alert alert-success py-2">
                        <i class="bi bi-info-circle"></i>
                        <small>WireGuard creates a secure tunnel between your router and VPS. No port forwarding needed - MikroTik connects outbound!</small>
                    </div>
                    
                    <div id="wgFields" style="{{ '' if router and router.wg_enabled else 'display: none;' }}">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">MikroTik WireGuard Public Key</label>
                                <input type="text" name="wg_public_key" class="form-control font-monospace" 
                                       value="{{ router.wg_public_key if router else '' }}" 
                                       placeholder="Paste public key from MikroTik">
                                <small class="text-muted">Generate on MikroTik: <code>/interface wireguard add name=wg-radius</code> then <code>:put [/interface wireguard get wg-radius public-key]</code></small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tunnel IP Address</label>
                                <input type="text" name="wg_allowed_ip" class="form-control" 
                                       value="{{ router.wg_allowed_ip if router else next_wg_ip }}" 
                                       placeholder="10.10.0.2/32">
                                <small class="text-muted">Unique IP for this router</small>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Preshared Key (Optional, extra security)</label>
                                <div class="input-group">
                                    <input type="text" name="wg_preshared_key" class="form-control font-monospace" id="pskInput"
                                           value="{{ router.wg_preshared_key if router else '' }}" 
                                           placeholder="Optional preshared key">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generatePSK()">
                                        <i class="bi bi-shuffle"></i> Generate
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MikroTik API Section -->
                    <hr class="my-4">
                    <div class="d-flex align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-hdd-network"></i> MikroTik API (For Instant Disconnect)</h6>
                        <div class="form-check form-switch ms-3">
                            <input class="form-check-input" type="checkbox" name="api_enabled" id="apiEnabled"
                                   {{ 'checked' if router and router.api_enabled else '' }} onchange="toggleApiFields()">
                            <label class="form-check-label" for="apiEnabled">Enable API</label>
                        </div>
                    </div>
                    
                    <div class="alert alert-info py-2">
                        <i class="bi bi-info-circle"></i>
                        <small>API allows instant user disconnect. If WireGuard is enabled, API will use the secure tunnel automatically.</small>
                    </div>
                    
                    <div id="apiFields" style="{{ '' if router and router.api_enabled else 'display: none;' }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">API IP Address</label>
                                <input type="text" name="api_ip" class="form-control" id="apiIpInput"
                                       value="{{ router.api_ip if router else '' }}" 
                                       placeholder="Auto-filled if WireGuard enabled">
                                <small class="text-muted">Leave empty to use WireGuard tunnel IP</small>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">API Port</label>
                                <input type="number" name="api_port" class="form-control" 
                                       value="{{ router.api_port if router else 8728 }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">API Username</label>
                                <input type="text" name="api_username" class="form-control" 
                                       value="{{ router.api_username if router else 'radiusapi' }}" 
                                       placeholder="radiusapi">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">API Password</label>
                                <div class="input-group">
                                    <input type="text" name="api_password" class="form-control" id="apiPassInput"
                                           value="{{ router.api_password if router else '' }}" 
                                           placeholder="Secure password">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generateApiPass()">
                                        <i class="bi bi-shuffle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('routers') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> {{ 'Update' if router else 'Add' }} Router
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function generateSecret() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let secret = '';
    for (let i = 0; i < 16; i++) {
        secret += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('secretInput').value = secret;
}

function generatePSK() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
    let psk = '';
    for (let i = 0; i < 44; i++) {
        psk += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('pskInput').value = psk;
}

function generateApiPass() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
    let pass = '';
    for (let i = 0; i < 16; i++) {
        pass += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('apiPassInput').value = pass;
}

function toggleWgFields() {
    const enabled = document.getElementById('wgEnabled').checked;
    document.getElementById('wgFields').style.display = enabled ? 'block' : 'none';
    
    // Auto-enable API when WireGuard is enabled
    if (enabled) {
        document.getElementById('apiEnabled').checked = true;
        toggleApiFields();
    }
}

function toggleApiFields() {
    const enabled = document.getElementById('apiEnabled').checked;
    document.getElementById('apiFields').style.display = enabled ? 'block' : 'none';
    
    // Auto-fill API IP from WireGuard IP
    if (enabled && document.getElementById('wgEnabled').checked) {
        const wgIp = document.querySelector('input[name="wg_allowed_ip"]').value;
        if (wgIp && !document.getElementById('apiIpInput').value) {
            document.getElementById('apiIpInput').value = wgIp.split('/')[0];
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleWgFields();
    toggleApiFields();
});
</script>
{% endblock %}
